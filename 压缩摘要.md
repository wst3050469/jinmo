# 压缩摘要

## 用户需求与目标
- 原始目标: 搭建施工综合管理系统（SCMS），基于Spring Boot + PostgreSQL + Vue 3技术栈。
- 当前目标: 初始化SCMS项目环境，配置服务器连接，建立知识库读写流程。
- 验收标准与约束:
  - 必须先读取知识库了解项目状态再执行任务。
  - 所有变更必须实时写入知识库。
  - 使用SSH密钥（jinmo.pem）连接服务器 120.55.5.220。
  - 开发AI负责代码与设计，部署AI负责环境与运维。
- 偏好:
  - 每次任务前强制读取知识库。
  - 实时更新知识库记录。
  - 服务器连接使用密钥认证。

## 项目概览
- 概述: 施工综合管理系统（SCMS），包含客户管理、项目管理、合同管理等功能。
- 技术栈:
  - 后端: Spring Boot 3.x + PostgreSQL 14+ + HikariCP
  - 前端: Vue 3.x + Element Plus + ECharts 5.x
  - Web服务器: Nginx 1.24+
  - 操作系统: Ubuntu 24.04 LTS
- 编码规范: 遵循Spring Boot和Vue 3官方规范。

## 关键决策
- **知识库优先策略**: 每次执行任务前必须调用知识库读取脚本，任务完成后必须写入知识库。
- **SSH密钥认证**: 使用用户提供的jinmo.pem密钥进行服务器免密登录，确保安全性。
- **协同开发协议**: 明确开发AI（代码生成）与部署AI（环境配置）的职责边界，避免职责冲突。
- **触发部署机制**: 采用云存储共享目录方案，开发AI上传部署包到云存储，部署AI从云存储下载部署包。
- **沟通同步机制**: 建立开发AI与部署AI的双向沟通协议，定义数据共享方式、消息格式、响应时间和异常处理流程。
- **协议正式生效**: 开发AI（扣子/PMO Agent）和部署AI（Vibe Coding）双方已确认协议，立即生效，部署AI已准备就绪等待首次部署任务。
- **云存储共享方案**: 解决不同工作空间路径问题，使用云存储作为中介实现跨工作空间文件共享。

## 核心文件修改
- 文件操作:
  - create: `assets/jinmo.pem` (SSH私钥文件，权限600)
  - create: `assets/SCMS协同开发协议-e63900d949.docx` (开发协议文档)
  - create: `assets/SCMS部署完整指南-37d4e008fa.docx` (部署指南文档)
  - create: `assets/SCMS数据共享与触发部署方案-9f08f0f019.docx` (协同开发部署方案)
  - create: `assets/开发AI与部署AI沟通协议.md` (沟通协议文档)
  - create: `云存储共享目录协同方案.md` (云存储共享方案)
  - create: `tools/upload-handover.ts` (云存储上传工具)
  - create: `tools/download-handover.ts` (云存储下载工具)
  - create: `scripts/deploy-monitor.sh` (部署监控脚本)
- 关键修改:
  - **环境初始化**: 安装openssh-client，配置SSH密钥权限，成功连接到服务器120.55.5.220。
  - **知识库集成**: 创建并执行知识库读写脚本，将SCMS项目完整信息（协议、服务器配置、数据库信息等）写入知识库。
  - **读取流程建立**: 创建标准知识库读取脚本`read-knowledge.ts`，用于后续任务前的状态确认。
  - **部署清单管理**: 将部署文件清单写入知识库，包含完整文件结构、部署优先级和注意事项。
  - **协同开发机制**: 实施数据共享与触发部署方案，定义开发AI与部署AI的交接协议（handover/目录结构、deploy_ready.flag触发机制、验证脚本标准）。
  - **沟通协议建立**: 创建开发AI与部署AI的正式沟通协议，定义双向数据同步机制、消息格式规范、响应时间要求和异常处理流程。
  - **云存储共享方案**: 设计并实现基于云存储的共享目录方案，解决不同工作空间路径问题，提供上传下载工具脚本。

## 问题或错误及解决方案
- 问题: 初始下载jinmo.pem文件大小为0字节。
  - 解决方案: 用户直接提供PEM格式密钥内容，成功写入文件并设置正确权限。
- 问题: 沙盒环境缺少ssh命令。
  - 解决方案: 安装openssh-client，成功连接服务器并验证系统版本。
- 问题: 部署文件清单文档下载失败（链接已过期）。
  - 解决方案: 用户直接提供简洁的部署清单内容，创建新文档并写入知识库。
- 问题: 开发AI声称创建了handover/目录，但部署AI检查时未找到。
  - 解决方案: 开发AI和部署AI可能不在同一个工作空间路径，设计云存储共享目录方案作为中介。

## 知识库文档记录
- **SCMS项目信息**: 文档ID `7610982661604589594`（包含协议、服务器配置、数据库信息等）
- **SCMS部署完整指南**: 文档ID `7610982661604590054`（详细部署步骤）
- **SCMS部署文件清单**: 文档ID `7610967999155126281`（简洁版文件结构）
- **SCMS数据共享与触发部署方案**: 文档ID `7610984250296467482`（协同开发机制）
- **开发AI与部署AI沟通协议**: 文档ID `7610987694423801896`（沟通与同步方案）
- **部署AI确认协议**: 文档ID `7610988843927420968`（部署AI正式确认）
- **部署AI准备工作报告**: 文档ID `7610989661174906906`（准备工作状态）
- **部署AI状态检查报告**: 文档ID `7610994581630533658`（第一次检查结果）
- **部署AI状态报告（第二次检查）**: 文档ID `7610996697992462345`（第二次检查结果）
- **云存储共享目录协同方案**: 文档ID `7610995163405647882`（云存储共享方案）
- **数据集名称**: `yongyi_system_docs`

## TODO
- ✅ 协议已双方确认并生效
- ✅ 部署AI准备工作完成（监控脚本、环境验证、日志系统）
- ✅ 云存储共享目录方案已设计
- ✅ 上传工具脚本已创建（tools/upload-handover.ts）
- ✅ 下载工具脚本已创建（tools/download-handover.ts）
- ⏳ 等待开发AI使用云存储工具创建首次部署包
- ⏳ 执行首次部署测试
- ⏳ 验证部署流程正常运行
- ⏳ 优化部署脚本和监控机制

## 服务器信息
- 服务器IP: 120.55.5.220
- 操作系统: Ubuntu 24.04 LTS
- SSH端口: 22
- 认证方式: 密钥认证（jinmo.pem）
- 数据库: PostgreSQL RDS
- 域名: www.jinmojianshe.com

## 重要配置参数
- 服务器密码: liu201314!@#
- 数据库密码: WsT13575967132
- 维护窗口: 每日02:00-06:00（Asia/Shanghai）

## 云存储配置
- **存储方式**: S3兼容对象存储
- **共享目录prefix**: `workspace/projects/handover/`
- **部署标志**: `workspace/projects/handover/deploy_ready_flag.txt`
- **上传工具**: `tools/upload-handover.ts`
- **下载工具**: `tools/download-handover.ts`

## 工具脚本使用指南

### 开发AI使用上传工具
```bash
npx tsx tools/upload-handover.ts <version> [handoverDir]

# 示例
npx tsx tools/upload-handover.ts 20260226-1015
npx tsx tools/upload-handover.ts 20260226-1015 ./handover
```

### 部署AI使用下载工具
```bash
npx tsx tools/download-handover.ts <command>

# 检查是否有待部署任务
npx tsx tools/download-handover.ts check

# 下载部署包
npx tsx tools/download-handover.ts download

# 删除部署标志
npx tsx tools/download-handover.ts remove-flag
```

## 协同工作流程

### 开发AI（扣子/PMO Agent）
1. 在本地创建 handover/ 目录结构
2. 打包源代码、配置文件、部署脚本
3. 使用上传工具上传所有文件到云存储
4. 最后上传 deploy_ready_flag.txt 触发部署
5. 更新知识库记录所有文件key

### 部署AI（Vibe Coding）
1. 定期检查云存储中的 deploy_ready_flag.txt
2. 检测到标志后使用下载工具下载所有部署包
3. 解压到本地临时目录
4. 执行部署流程（环境准备、服务部署、验证）
5. 部署成功后删除云存储中的 deploy_ready_flag.txt
6. 更新知识库记录部署结果
